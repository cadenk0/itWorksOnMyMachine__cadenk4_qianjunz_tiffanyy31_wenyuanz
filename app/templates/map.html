{% extends "base.html" %}
{% block title %}Home - itWorksOnMyMachine{% endblock %}
{% block content %}

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<!-- Search Box -->
<div class="relative w-64 font-mono mb-40">
  <input
    id="countrySearch"
    type="text"
    placeholder="Search by country..."
    oninput="filterSuggestions()"
    autocomplete="off"
    class="w-full p-2 border border-gray-400 rounded"
  >
  <div
    id="suggestions"
    class="absolute top-full left-0 right-0 bg-white border border-gray-300 max-h-40 overflow-y-auto z-50 hidden rounded shadow"
  ></div>
</div>

<!-- Map -->
<div class="mt-4">
  <div id="map" class="h-[80vh] w-full rounded shadow"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  const map = L.map('map').setView([20, 0], 2);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
  }).addTo(map);

  const landmarks = {{ landmarks | tojson }};
  const countries = [...new Set(landmarks.map(l => l.country))].filter(Boolean).sort();
  let markers = [];

  function clearMarkers() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
  }

  function showMarkers(data) {
    clearMarkers();
    data.forEach(l => {
      const marker = L.marker([l.latitude, l.longitude])
        .addTo(map)
        .bindPopup(`
          <div>
            <b>${l.name}</b>
            <br>${l.description}<br>
            <i>${l.country}</i>
            <div class="flex justify-end">
              <button
                onclick="alert('Added to Favorites!')"
                class="border border-red-500 text-red-500 px-3 py-1 rounded hover:bg-red-100 transition"
              >
                Favorite
              </button>
            </div>
          </div>
        `);
      markers.push(marker);
    });
  }

  function filterMarkers(query) {
    const filtered = landmarks.filter(l => l.country.toLowerCase() === query.toLowerCase());
    showMarkers(filtered);
  }

  function filterSuggestions() {
    const input = document.getElementById("countrySearch");
    const query = input.value.toLowerCase();
    const suggestionBox = document.getElementById("suggestions");

    suggestionBox.innerHTML = "";
    if (!query) {
      suggestionBox.classList.add("hidden");
      return;
    }

    const matches = countries.filter(c => c.toLowerCase().includes(query));
    if (matches.length === 0) {
      suggestionBox.classList.add("hidden");
      return;
    }

    matches.forEach(country => {
      const div = document.createElement("div");
      div.textContent = country;
      div.className = "px-3 py-2 hover:bg-gray-100 cursor-pointer";
      div.onclick = () => {
        document.getElementById("countrySearch").value = country;
        suggestionBox.classList.add("hidden");
        filterMarkers(country);
      };
      suggestionBox.appendChild(div);
    });

    suggestionBox.classList.remove("hidden");
  }

  document.addEventListener("click", (e) => {
    const suggestionBox = document.getElementById("suggestions");
    const input = document.getElementById("countrySearch");
    if (!suggestionBox.contains(e.target) && e.target !== input) {
      suggestionBox.classList.add("hidden");
    }
  });
</script>

{% endblock %}
